{% extends "layout/base.html" %}

{% block head %}
<link href="{{ url_for('static', filename='css/typeahead.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/jqcloud.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container">
    <!-- <div class="page-header"> -->
        <span style="color: #ff6600; font-weight:bold; font-size: 39px;">What's happening around you?</span>
        <p class="lead">Find current social activity that stands out from the background.</p>
    <!-- </div> -->

    <div class ="col-md-12">

        <div id="map-container" class="col-md-6">
            <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places,visualization&sensor=true_or_false">
            </script>
        </div>

        <!-- The location entry field -->
        <div class ="col-md-6">
            <div class="well" style="height:330px;">
                <!-- User-input location -->
                <div class="thumbnail">
                  <div class="caption">
                    <span style="color: #ff6600; font-weight:bold; font-size: 20px;">Where to look?</span>
                    <p>Type the name of an area to explore</p>
                        <form action="/results_location" method="POST" class="form-horizontal">
                            <div class="form-group">
                                <div class="col-md-9">
                                    <input type="text" name="location" class="form-control" id="whereToLook" placeholder="e.g., Mission Street, San Francisco, CA">
                                </div>
                                <div class="col-md-3">
                                    <button type="submit_loc" style="background-color: #ff6600; color: white;" name="query" class="btn btn-default">Continue</button>
                                </div>
                            </div>
                        </form>
                </div>
            </div>

            <!-- Predefined location -->
            <div class="thumbnail">
              <div class="caption">
                <span style="color: #ff6600; font-weight:bold; font-size: 20px;">Examples</span>
                <p>Or choose from these examples</p>
                <form action="/results_predef" method="POST" class="form-horizontal">
                    <div class="form-group">
                        <div class="col-md-9">
                            <select class="form-control" name="event_id" id="predef">
                            {% for event in examples %}
                                <option value="{{ event["id"] }}">{{ event["name"] }}</option>
                            {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit_predef" style="background-color: #ff6600; color: white;" class="btn btn-default">Continue</button>
                        </div>
                    </div>
                </form>
              </div>
            </div>

         <!-- Closing the well -->
         </div>

        <!-- <div id="chart_div" style="width: 900px; height: 500px;"></div> -->
        <div id="chart_div"></div>

        <!-- Closing the location entry field -->
    </div>


    <!-- Closing map and location input row -->
    </div>

    <!-- Word cloud -->
    <div class ="col-md-6">
        <h3>Nearby topics</h3>
        <div id="example" style="width: 450px; height: 250px;"></div>
    </div>
    <div class ="col-md-6">
        <h3>Nearby photos</h3>
    </div>
</div><!-- /.container -->


{% endblock %}

<!--==============================================================-->
{% block scripts %}

<script>
function init_map() {
    
    var var_location = new google.maps.LatLng({{ user_lat }}, {{ user_lon }});
    var sw = new google.maps.LatLng({{ latlng_sw }});
    var ne = new google.maps.LatLng({{ latlng_ne }});
    var var_bounds = new google.maps.LatLngBounds(sw, ne);
    
    var var_ourmap = mapIt(var_location,var_bounds)
    
    //Build color icons for clusters         
    var iconArray = new Array();
    var iconColor = ["D1D1E0","FF9933","FFFF66","00CC00","0066FF","CC0099"]
    // ["gray","orange","yellow","green","blue","purple"]
    for (i = 0; i < {{ncluster}}+1 ; i++) {
        iconArray[i] = { url: "http://www.googlemapsmarkers.com/v1/"+i+"/"+iconColor[i]+"/"}
    }

    {% if heatmap %}
        var heatMapData = []
        {% for result in results %}
            heatMapData.push(
                {location: new google.maps.LatLng({{ result['lat'] }},{{ result['long'] }}), weight: 1}
                );
        {% endfor %}

        // DEBUG
        // console.log(heatMapData)

        // set heat map
        var pointArray = new google.maps.MVCArray(heatMapData);
        var heatmap = new google.maps.visualization.HeatmapLayer({
            data: pointArray
        });
        heatmap.setMap(var_ourmap);

        {% for clus in clus_centers %}
            // addCentroidMarker(var_ourmap,{{ clus['lat'] }}, {{ clus['long'] }}, {{ clus['clusterid'] }})
            addPinMarker(var_ourmap,{{ clus['lat'] }}, {{ clus['long'] }}, {{ clus['clusterid'] }})
            // addPinMarkerWithInfo(var_ourmap,{{ clus['lat'] }}, {{ clus['long'] }}, {{ clus['clusterid'] }})
        {% endfor %}
    {% else %}
        {% for result in results %}
            addPinMarker(var_ourmap,{{ result['lat'] }}, {{ result['long'] }}, {{ result['clusterid'] }})
        {% endfor %}
    {% endif %}
    
    function getMakerImage(ID) {
        return iconArray[ID]
    }
    
    function mapIt(var_location) {
        var var_mapoptions = {
            center: var_location,
            zoom: 14
            // mapTypeId: google.maps.MapTypeId.SATELLITE
        };

        var var_map = new google.maps.Map(document.getElementById("map-container"),
            var_mapoptions);
        var_map.panToBounds(var_bounds)
            
        // var var_marker = new google.maps.Marker({
        //     position: var_location,
        //     map: var_map,
        //     title:"You"});

        // // var_marker.setMap(var_map);
        
        return var_map
    }
    
    function addPinMarker(this_map,thislat,thislong,thisID) {
        var latlong = new google.maps.LatLng(thislat,thislong)

        var this_marker = new google.maps.Marker({
            position: latlong,
            map: this_map,
            icon: getMakerImage(thisID+1)
            })

        // this_marker.setMap(this_map);
    }

    function addPinMarkerWithInfo(this_map,thislat,thislong,thisID,infoWindow) {
        // https://github.com/helenaxwang/AveNeue/blob/master/flask_site/app/templates/map_basic.html
        var latlong = new google.maps.LatLng(thislat,thislong)

        var this_marker = new google.maps.Marker({
            position: latlong,
            map: this_map,
            icon: getMakerImage(thisID+1)
            })

        var infoWindow = new google.maps.InfoWindow();

        google.maps.event.addListener(this_marker, 'click', function(event) {
            infoWindow.setPosition(latlong);
            infoWindow.setContent('TiH' + '<br>' + 'Event');
            infoWindow.open(this_map,this);
        });
    }

    function addCentroidMarker(this_map,thislat,thislong,thisID) {
        var latlong = new google.maps.LatLng(thislat,thislong)

        var this_marker = new google.maps.Marker({
            position: latlong,
            map: this_map,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 3
            },
            })

        // this_marker.setMap(this_map);
    }
    
}

google.maps.event.addDomListener(window, 'load', init_map);
</script>

<!-- source for visualization (google visualization library) -->
<script type="text/javascript" src="https://www.google.com/jsapi"></script> 
<script>
// var showImages = function(urls) {
//   if (urls.length < 3) {
//     console.log('not enough urls');
//     return;
//   }
  
//   // If image source hasn't chnaged, don't do anything.
//   var firstImgURL = $('#first-img').attr('src');
//   if (firstImgURL == urls[0]['static']) {
//     return;
//   }
  

//   // Hide images
//   $('.flickr-image').css('opacity', 0);
//   $('#first-img').attr('src', urls[0]['static']);
//   $('#first-link').attr('href', urls[0]['flickr']);
//   $('#second-img').attr('src', urls[1]['static']);
//   $('#second-link').attr('href', urls[1]['flickr']);
//   $('#third-img').attr('src', urls[2]['static']);
//   $('#third-link').attr('href', urls[2]['flickr']);
// }


// Load the Visualization API and the corechart package.
google.load("visualization", "1", {packages:["corechart"]});
google.setOnLoadCallback(drawChart);
function drawChart() { //javascript
    var arrayData = []
    // arrayData.push(['Date', 'Count'])
    {% for dat in plotdata %}
        arrayData.push([new Date("{{ dat[0] }}"), {{ dat[1] }} ])
        // console.log("{{ dat[0] }}")
        // console.log(new Date("{{ dat[0] }}"))
    {% endfor %}

    // Not enough data to plot
    // TODO: Display an error message.
    // if (arrayData.length < 2) return;
    
    var data = new google.visualization.DataTable();
    data.addColumn('datetime', 'Time');
    data.addColumn('number','Count');
    data.addRows(arrayData);

    // var formatter = new google.visualization.DateFormat({formatType: 'long', timeZone: -7});
    // formatter.format(data, 0);
    // console.log(data);

    // Set chart options
    var options = {
     'title':"", //options object takes lots of things, incliuding colors, so it is an easy way of customizing visualization - go look at docs.
     'curveType': 'function',
     'width':500,
     'height':300,
     'backgroundColor': '#f4f7f2',
     'chartArea': {
       'left': 65,
       'top': 20,
       'width': 420,
       // 'height': 300
      },
      'vAxis':  {
       'viewWindowMode': 'maximized',
       'title': 'Activity',
       'gridlines': {
         'color': '#e3e3e3'
       }
      },
      'hAxis':  {
       'viewWindowMode': 'maximized',
       'minTextSpacing':55,
      },
      'legend': {
       'position': 'bottom'
      }
    };
    
    // Instantiate and draw our chart, passing in some options.
    var chart = new google.visualization.LineChart(document.getElementById('chart_div')); //raw javascript NOT jQuery
    chart.draw(data, options);
}
</script>




<script src="{{ url_for('static', filename='js/typeahead.min.js') }}"></script>
<script>
$("document").ready(function(){
    $("#desintationEntry").typeahead({
        name : 'dest',
        hint: false,
        minLength: 1,
        prefetch: '/prefetch/prefetch', 
    });
});
</script>
<script>    
    //autocomplete for whereToLook
    var input = /** @type {HTMLInputElement} */(
      document.getElementById('whereToLook'));
    var autocomplete = new google.maps.places.Autocomplete(input);
    //restrict to Bay Area
    var sw = google.maps.LatLng(37.3333, -122.5311);
    var ne = google.maps.LatLng(37.9736, -121.9000);
    var LatLngBounds = google.maps.LatLngBounds(sw, ne);
    autocomplete.setBounds(LatLngBounds);
</script>

<script src="{{ url_for('static', filename='js/jqcloud-1.0.4.min.js') }}"></script>
<script type="text/javascript">
    var word_list = []
    {% for cluster in word_array %}
        {% for words in cluster %}
            word_list.push({text: "{{ words['text'] }}", weight: {{ words['weight'] }} })
        {% endfor %}
    {% endfor %}
    $(function() {
        $("#example").jQCloud(word_list);
    });
    </script>

<script>
    $(document).ready(function($) { 
        $("#predef").val({{ selected|tojson }}); // set dropdown to curr value
    });
</script>
<!--=================================================-->
{% endblock %}

{# commenting out
{% block footer %}
  {% include "include/footer.html" %}
{% endblock %}
#}
